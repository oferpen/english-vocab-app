generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ParentAccount {
  id                String         @id @default(cuid())
  pinHash           String?
  email             String?        @unique
  googleId          String?        @unique
  name              String?
  image             String?
  createdAt         DateTime       @default(now())
  lastActiveChildId String?
  settingsJson      String         @default("{}")
  children          ChildProfile[]

  @@map("parent_accounts")
}

model ChildProfile {
  id              String           @id @default(cuid())
  parentAccountId String
  name            String
  avatar          String?
  age             Int?
  grade           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  parentAccount   ParentAccount    @relation(fields: [parentAccountId], references: [id], onDelete: Cascade)
  letterProgress  LetterProgress[]
  levelState      LevelState?
  missionStates   MissionState[]
  progress        Progress[]
  quizAttempts    QuizAttempt[]

  @@map("child_profiles")
}

model Word {
  id                String        @id @default(cuid())
  englishWord       String        @unique
  hebrewTranslation String
  phonetic          String?
  exampleEn         String?
  exampleHe         String?
  category          String?
  difficulty        Int           @default(1)
  level             Int           @default(1)
  imageUrl          String?
  audioUrl          String?
  active            Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  progress          Progress[]
  quizAttempts      QuizAttempt[]

  @@map("words")
}

model Progress {
  id               String       @id @default(cuid())
  childId          String
  wordId           String
  timesSeenInLearn Int          @default(0)
  quizAttempts     Int          @default(0)
  quizCorrect      Int          @default(0)
  lastSeenAt       DateTime?
  masteryScore     Int          @default(0)
  needsReview      Boolean      @default(false)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @default(now())
  child            ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)
  word             Word         @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([childId, wordId])
  @@map("progress")
}

model QuizAttempt {
  id           String       @id @default(cuid())
  childId      String
  wordId       String
  createdAt    DateTime     @default(now())
  questionType String
  correct      Boolean
  isExtra      Boolean      @default(false)
  child        ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)
  word         Word         @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@map("quiz_attempts")
}

model MissionState {
  id              String       @id @default(cuid())
  childId         String
  periodType      String
  missionKey      String
  progress        Int          @default(0)
  target          Int
  completed       Boolean      @default(false)
  periodStartDate String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @default(now())
  child           ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@unique([childId, periodType, missionKey, periodStartDate])
  @@map("mission_states")
}

model LevelState {
  id        String       @id @default(cuid())
  childId   String       @unique
  level     Int          @default(1)
  xp        Int          @default(0)
  updatedAt DateTime     @default(now())
  child     ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@map("level_states")
}

model Letter {
  id             String           @id @default(cuid())
  letter         String           @unique
  name           String
  hebrewName     String?
  sound          String?
  imageUrl       String?
  audioUrl       String?
  order          Int
  active         Boolean          @default(true)
  createdAt      DateTime         @default(now())
  letterProgress LetterProgress[]

  @@map("letters")
}

model LetterProgress {
  id           String       @id @default(cuid())
  childId      String
  letterId     String
  timesSeen    Int          @default(0)
  timesCorrect Int          @default(0)
  mastered     Boolean      @default(false)
  lastSeenAt   DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @default(now())
  child        ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)
  letter       Letter       @relation(fields: [letterId], references: [id], onDelete: Cascade)

  @@unique([childId, letterId])
  @@map("letter_progress")
}
